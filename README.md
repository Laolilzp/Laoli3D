# ComfyUI Laoli 3D Pose Editor (老李 3D 姿势编辑器)


<img width="2813" height="1277" alt="Laoli3D" src="https://github.com/user-attachments/assets/1a4c3e4e-d6c7-4ccc-bd8a-de125ecb8f94" />


## 🎯 目的：为什么开发这个插件？

在使用 Comfyui 进行 AI 绘图时，我们经常面临一个痛点：**提示词（Prompt）无法精准控制人物的动作**。

无论你如何详细地描述“左手举高45度”、“右腿后撤半步”，AI 往往难以理解具体的空间关系，导致生成的肢体扭曲或动作不达标。现有的 ControlNet 虽然强大，但寻找完美的参考图往往是大海捞针。

**Laoli 3D Pose Editor** 旨在解决这个问题。它在 ComfyUI 内部提供了一个轻量级、可视化的 3D 编辑环境，让你像玩游戏捏人一样，精准地调整人物的每一个关节，并直接生成 ControlNet 所需的各种控制图。**所见即所得，让 AI 严格按照你的意愿画图。**

## ✨ 核心特点

*   **👥 多人同屏编辑**：支持在同一场景中添加无限数量的角色，轻松构建复杂的双人互动或多人构图场景。
*   **🖼️ 多种 ControlNet 输出**：一次渲染，同时输出四种图像，满足不同 ControlNet 模型的需求：
    *   **RGB 渲染图**：所见即所得的预览。
    *   **OpenPose 骨骼图**：精准对应标准 OpenPose 格式。
    *   **Depth 深度图**：用于控制空间前后关系。
    *   **Normal 法线图**：用于控制物体表面凹凸细节。
*   **🧩 自定义模型导入**：不局限于内置模型！支持导入你自己的 `.glb` 格式 3D 模型（如 Mixamo 角色或动漫模型），只需放入本插件js\assets文件夹即可识别。
*   **📷 高清框选截图**：内置高级截图功能，支持**比例锁定**和**视口偏移**。无论你在屏幕上怎么缩放，都能截取指定分辨率（如 1024x1024）的高清局部特写，且无黑边、无拉伸。
*   **💾 状态自动保存**：刷新网页或重启 ComfyUI，场景中的人物、姿势和位置会自动恢复，无需重新摆放。

## 🛠️ 功能列表

*   **骨骼操作**：支持旋转 (Rotate)、缩放 (Scale)。
*   **全局位移**：支持移动人物在场景中的 X/Y/Z 位置及整体缩放。
*   **姿势库**：内置姿势保存与读取功能，建立你自己的动作素材库。
*   **UI 交互**：优化的 3D 视口，支持鼠标左键旋转、右键平移、滚轮缩放。

## 🚀 安装方法

1.  进入你的 ComfyUI 插件目录：
    ```bash
    cd ComfyUI/custom_nodes/
    ```
2.  克隆本仓库：
    ```bash
    git clone https://github.com/Laolilzp/Laoli3D.git
    ```
3.  重启 ComfyUI。

## 📖 使用指南

### 1. 基础操作
*   **添加节点**：在 ComfyUI 画布中右键 -> `Laoli3D` -> `Laoli 3D Pose Editor`。
*   **选择关节**：在 3D 视窗中直接点击人物身上的蒙皮，或在左侧列表中选择骨骼。
*   **快捷键**：
    *   `R`：切换到旋转模式 (Rotate)。
    *   `S`：切换到缩放模式 (Scale)。
    *   `W`：切换到移动模式 (仅限根骨骼 Hips/Root)。
    *   `↑ ↓、← →、+-`：微调选中骨骼的角度。
*   **相机控制**：
    *   左键拖拽（空白处）：旋转视角。
    *   右键拖拽：平移视角。
    *   滚轮：缩放视角。

### 2. 输出与 ControlNet 连接
节点提供 4 个图像输出端口，建议连接方式（待测试。。。）：
*   `OpenPose_Map` -> 连接到 ControlNet (预处理器选择 `None` 或手动指定 OpenPose)。
*   `Depth_Map` -> 连接到 ControlNet (预处理器选择 `None`，模型选 Depth)。
*   `Normal_Map` -> 连接到 ControlNet (预处理器选择 `None`，模型选 Normal)。

### 3. 如何导入自定义模型
1.  准备 `.glb` 格式的 3D 模型文件（建议带有标准骨骼绑定，如 Mixamo 导出的模型）。
2.  将文件放入插件目录下的 `assets` 文件夹：
    ```
    ComfyUI/custom_nodes/Laoli3D/js/assets/你的模型.glb
    ```
3.  刷新 ComfyUI 网页，在编辑器的顶部下拉菜单中即可看到新模型。

## ⚠️ 不足与已知问题 (Limitations)

虽然本插件已经能够满足大部分绘图辅助需求，但仍有以下改进空间，欢迎社区贡献：

1.  **没有反向动力学 (IK)**：目前采用正向动力学 (FK)，即调整手部位置需要分别调整大臂、小臂和手掌的角度，无法直接拖拽手掌带动胳膊（这也是为了保证骨骼旋转的绝对精准）。
2.  **骨骼命名兼容性**：目前主要适配 Mixamo 和标准 VRM/GLTF 骨骼命名规范。如果导入的自定义模型骨骼命名非常规，可能会导致无法识别或控制。
3.  **浏览器性能**：场景中如果放入过多高面数的 3D 模型，可能会导致网页端卡顿，建议使用低模。
4.  **撤销/重做**：暂不支持 Ctrl+Z 撤销操作，请谨慎调整或勤用保存功能。

## 🤝 贡献 (Contributing)

欢迎提交 Issues 和 Pull Requests！如果你有更好的想法或发现了 Bug，请随时告诉我。

## 📄 许可证 (License)

[MIT License](LICENSE)

***
